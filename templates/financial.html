{% extends "base.html" %}
{% block title %}Financial Support | Kisan Sahayata{% endblock %}
{% block nav_extra %}
<a href="{{ url_for('index') }}" class="nav-home-btn ms-2"><i class="fas fa-home me-1"></i>Home</a>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="scheme-header text-center">
    <h1 class="scheme-title"><span class="emoji">üí∞</span>Financial Support</h1>
    <p class="scheme-subtitle">Loans, subsidies, grants &amp; financial assistance for farmers</p>
  </div>

  <!-- Active Filter Pills -->
  <div id="activeFilters" class="text-center mb-3"></div>


  <div id="resultsInfo" class="text-center mb-3 text-muted small" style="display:none;"></div>

  <div id="financialContainer" class="scheme-grid mt-2">
    <div class="text-center py-5">
      <div class="spinner-border text-success"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const params = new URLSearchParams(window.location.search);
  let currentType = params.get('type') || 'All';
  let supportType = params.get('supportType') || '';
  let farmerType = params.get('farmerType') || '';
  let age = params.get('age') || '';
  let farmerName = params.get('farmer') || '';

  // Highlight active type filter
  document.querySelectorAll('#typeFilterBar .filter-btn').forEach(btn => {
    if (btn.dataset.type === currentType) btn.classList.add('active');
    btn.addEventListener('click', function () {
      document.querySelectorAll('#typeFilterBar .filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentType = this.dataset.type;
      supportType = ''; farmerType = ''; age = '';
      document.getElementById('activeFilters').innerHTML = '';
      loadSchemes();
    });
  });

  // Show filter pills
  function showFilterPills() {
    const pills = [];
    if (farmerName) pills.push(`üë§ ${farmerName}`);
    if (currentType && currentType !== 'All') pills.push(`üèõÔ∏è ${currentType}`);
    if (supportType) pills.push(`üíº ${supportType}`);
    if (farmerType) pills.push(`üöú ${farmerType}`);
    if (age) pills.push(`üéÇ Age: ${age}`);
    const box = document.getElementById('activeFilters');
    if (pills.length > 0) {
      box.innerHTML = `<span class="text-muted me-2">Filters:</span>` +
        pills.map(p => `<span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-pill px-3 py-1 me-1">${p}</span>`).join('') +
        `<a href="/financial" class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3 py-1 ms-2 text-decoration-none">‚úñ Clear</a>`;
    }
  }

  // Keyword maps
  const supportTypeKeywords = {
    loan: ['loan', 'credit', 'kcc', 'working capital', 'crop loan'],
    pension: ['pension', 'maandhan', 'retirement', 'monthly income', '3000'],
    infrastructure: ['infrastructure', 'cold storage', 'warehouse', 'aif', 'post harvest'],
    subsidy: ['subsidy', 'grant', 'interest subsidy', 'subvention']
  };
  const farmerTypeKeywords = {
    small: ['small', 'marginal', 'all farmer'],
    sharecropper: ['sharecropper', 'tenant', 'shg', 'all farmer'],
    fpo: ['fpo', 'shg', 'farmer producer', 'cooperative', 'all farmer'],
    entrepreneur: ['entrepreneur', 'agri', 'all farmer']
  };
  const ageKeywords = {
    '18to40': ['18-40', '18 to 40', 'pension', 'maandhan'],
    above40: ['all farmer', 'all', 'general']
  };

  function clientFilter(schemes) {
    let result = schemes;
    if (supportType && supportTypeKeywords[supportType]) {
      const kws = supportTypeKeywords[supportType];
      result = result.filter(s => {
        const text = `${s.title} ${s.description} ${s.tags} ${s.benefits}`.toLowerCase();
        return kws.some(k => text.includes(k));
      });
    }
    if (farmerType && farmerTypeKeywords[farmerType]) {
      const kws = farmerTypeKeywords[farmerType];
      result = result.filter(s => {
        const text = `${s.eligibility} ${s.description}`.toLowerCase();
        return kws.some(k => text.includes(k));
      });
    }
    if (age && ageKeywords[age]) {
      const kws = ageKeywords[age];
      result = result.filter(s => {
        const text = `${s.eligibility} ${s.description} ${s.tags}`.toLowerCase();
        return kws.some(k => text.includes(k));
      });
    }
    return result;
  }

  function loadSchemes() {
    const c = document.getElementById('financialContainer');
    c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div></div>';

    let url = '/api/schemes?category=financial';
    if (currentType && currentType !== 'All') url += '&type=' + currentType;

    fetch(url).then(r => r.json()).then(schemes => {
      let filtered = clientFilter(schemes);

      const infoEl = document.getElementById('resultsInfo');
      infoEl.style.display = 'block';
      infoEl.innerHTML = filtered.length === schemes.length
        ? `Showing all <strong>${filtered.length}</strong> financial schemes`
        : `Showing <strong>${filtered.length}</strong> of ${schemes.length} schemes matching your criteria`;

      if (!filtered.length) {
        c.innerHTML = `
        <div class="text-center py-5">
          <div style="font-size:3rem;">üîç</div>
          <h4 class="text-muted mt-3">No schemes matched your filters</h4>
          <p class="text-muted">Try different criteria or <a href="/financial">view all financial schemes</a></p>
        </div>`;
        return;
      }

      c.innerHTML = filtered.map(s => `
      <div class="scheme-card-modern">
        <span class="badge ${s.scheme_type === 'Central' ? 'bg-primary' : 'bg-success'} mb-2">${s.scheme_type}</span>
        <h4>${s.title}</h4>
        <p><b>Eligibility:</b> ${s.eligibility || 'See details'}</p>
        <p><b>Benefits:</b> ${(s.benefits || '').substring(0, 100)}...</p>
        <p><b>Deadline:</b> ${s.deadline || 'Ongoing'}</p>
        <div class="scheme-btns-modern">
          <a href="${s.official_url || '#'}" target="_blank" class="btn-apply">Apply Now</a>
          <a href="/scheme_detail?id=${s.id}" class="btn-details">View Details</a>
        </div>
      </div>`).join('');
    }).catch(() => {
      c.innerHTML = '<div class="alert alert-danger">Failed to load schemes. Please try again.</div>';
    });
  }

  showFilterPills();
  loadSchemes();
</script>
{% endblock %}