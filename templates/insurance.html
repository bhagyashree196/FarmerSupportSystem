{% extends "base.html" %}
{% block title %}Insurance Schemes | Kisan Sahayata{% endblock %}
{% block nav_extra %}
<a href="{{ url_for('index') }}" class="nav-home-btn ms-2"><i class="fas fa-home me-1"></i>Home</a>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="scheme-header text-center">
    <h1 class="scheme-title"><span class="emoji">üõ°Ô∏è</span>Insurance Schemes</h1>
    <p class="scheme-subtitle">Crop, life, livestock &amp; accident insurance for farmers</p>
  </div>

  <!-- Active Filter Pills -->
  <div id="activeFilters" class="text-center mb-3"></div>

  <div id="resultsInfo" class="text-center mb-3 text-muted small" style="display:none;"></div>

  <div id="insuranceContainer" class="scheme-grid mt-2">
    <div class="text-center py-5"><div class="spinner-border text-success"></div></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const params      = new URLSearchParams(window.location.search);
let currentType   = params.get('type')      || 'All';
let coverType     = params.get('coverType') || '';
let season        = params.get('season')    || '';
let risk          = params.get('risk')      || '';
let farmerName    = params.get('farmer')    || '';

// Highlight active type filter
document.querySelectorAll('#typeFilterBar .filter-btn').forEach(btn => {
  if (btn.dataset.type === currentType) btn.classList.add('active');
  btn.addEventListener('click', function(){
    document.querySelectorAll('#typeFilterBar .filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentType = this.dataset.type;
    coverType = ''; season = ''; risk = '';
    document.getElementById('activeFilters').innerHTML = '';
    loadSchemes();
  });
});

// Show filter pills
function showFilterPills() {
  const pills = [];
  if (farmerName)  pills.push(`üë§ ${farmerName}`);
  if (currentType && currentType !== 'All') pills.push(`üèõÔ∏è ${currentType}`);
  if (coverType)   pills.push(`üõ°Ô∏è ${coverType}`);
  if (season)      pills.push(`üå¶Ô∏è ${season}`);
  if (risk)        pills.push(`‚ö†Ô∏è ${risk}`);
  const box = document.getElementById('activeFilters');
  if (pills.length > 0) {
    box.innerHTML = `<span class="text-muted me-2">Filters:</span>` +
      pills.map(p => `<span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill px-3 py-1 me-1">${p}</span>`).join('') +
      `<a href="/insurance" class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3 py-1 ms-2 text-decoration-none">‚úñ Clear</a>`;
  }
}

// Keyword maps
const coverTypeKeywords = {
  crop:      ['crop','fasal','bima','pmfby','kharif','rabi','sowing'],
  life:      ['life','jeevan','death','jyoti','pmjjby','accident'],
  calamity:  ['calamity','drought','flood','unseasonal','natural','relief','sahayata'],
  accident:  ['accident','life','death','all farmer','bank account']
};
const seasonKeywords = {
  kharif:  ['kharif','sowing','cotton','rice','soybean'],
  rabi:    ['rabi','wheat','gram'],
  annual:  ['annual','all season','all farmer','ongoing']
};
const riskKeywords = {
  drought: ['drought','water stress','dry'],
  flood:   ['flood','excess rain','unseasonal','waterlogging'],
  pest:    ['pest','disease','insect'],
  death:   ['death','life','accident','coverage','jeevan']
};

function clientFilter(schemes) {
  let result = schemes;
  if (coverType && coverTypeKeywords[coverType]) {
    const kws = coverTypeKeywords[coverType];
    result = result.filter(s => {
      const text = `${s.title} ${s.description} ${s.tags} ${s.benefits}`.toLowerCase();
      return kws.some(k => text.includes(k));
    });
  }
  if (season && seasonKeywords[season]) {
    const kws = seasonKeywords[season];
    result = result.filter(s => {
      const text = `${s.title} ${s.description} ${s.tags}`.toLowerCase();
      return kws.some(k => text.includes(k));
    });
  }
  if (risk && riskKeywords[risk]) {
    const kws = riskKeywords[risk];
    result = result.filter(s => {
      const text = `${s.description} ${s.tags} ${s.benefits} ${s.eligibility}`.toLowerCase();
      return kws.some(k => text.includes(k));
    });
  }
  return result;
}

function loadSchemes() {
  const c = document.getElementById('insuranceContainer');
  c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div></div>';

  let url = '/api/schemes?category=insurance';
  if (currentType && currentType !== 'All') url += '&type=' + currentType;

  fetch(url).then(r => r.json()).then(schemes => {
    let filtered = clientFilter(schemes);

    const infoEl = document.getElementById('resultsInfo');
    infoEl.style.display = 'block';
    infoEl.innerHTML = filtered.length === schemes.length
      ? `Showing all <strong>${filtered.length}</strong> insurance schemes`
      : `Showing <strong>${filtered.length}</strong> of ${schemes.length} schemes matching your criteria`;

    if (!filtered.length) {
      c.innerHTML = `
        <div class="text-center py-5">
          <div style="font-size:3rem;">üîç</div>
          <h4 class="text-muted mt-3">No schemes matched your filters</h4>
          <p class="text-muted">Try different criteria or <a href="/insurance">view all insurance schemes</a></p>
        </div>`;
      return;
    }

    c.innerHTML = filtered.map(s => `
      <div class="scheme-card-modern">
        <span class="badge ${s.scheme_type === 'Central' ? 'bg-primary' : 'bg-success'} mb-2">${s.scheme_type}</span>
        <h4>${s.title}</h4>
        <p><b>Eligibility:</b> ${s.eligibility || 'See details'}</p>
        <p><b>Benefits:</b> ${(s.benefits || '').substring(0, 100)}...</p>
        <p><b>Deadline:</b> ${s.deadline || 'Ongoing'}</p>
        <div class="scheme-btns-modern">
          <a href="${s.official_url || '#'}" target="_blank" class="btn-apply">Apply Now</a>
          <a href="/scheme_detail?id=${s.id}" class="btn-details">View Details</a>
        </div>
      </div>`).join('');
  }).catch(() => {
    c.innerHTML = '<div class="alert alert-danger">Failed to load schemes. Please try again.</div>';
  });
}

showFilterPills();
loadSchemes();
</script>
{% endblock %}